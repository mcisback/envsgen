# Envsgen Tutorial: Real-World PHP + MySQL + Caddy Setup

This tutorial demonstrates how to use **envsgen** to manage a complete web application stack with a single source of truth for all your configuration files.

## ðŸŽ¯ What We'll Build

A production-ready setup for a PHP application with:
- **Caddy** as the reverse proxy with HTTPS
- **PHP-FPM** running your application
- **MySQL** as the database
- **Docker Compose** orchestrating everything
- **Shared secrets** across all services

From one master configuration, we'll generate:
- `.env` files for local and production environments
- `docker-compose.yml` for Docker orchestration
- `Caddyfile` for reverse proxy configuration
- Bash scripts for CI/CD pipelines

---

## ðŸ“ Project Structure

```
myproject/
â”œâ”€â”€ configs/
â”‚   â”œâ”€â”€ master.toml       # Main entry point (imports everything)
â”‚   â”œâ”€â”€ shared.toml       # Shared secrets & variables
â”‚   â”œâ”€â”€ apps.toml         # PHP application config
â”‚   â”œâ”€â”€ docker.toml       # Docker Compose configuration
â”‚   â””â”€â”€ caddy.toml        # Caddyfile configuration
â”œâ”€â”€ caddy/
â”‚   â””â”€â”€ Caddyfile         # Generated by envsgen
â”œâ”€â”€ docker/
â”‚   â””â”€â”€ docker-compose.yml # Generated by envsgen
â”œâ”€â”€ apps/
â”‚   â””â”€â”€ myphpapp.com/
â”‚       â”œâ”€â”€ .env.local     # Generated by envsgen
â”‚       â”œâ”€â”€ .env.prod      # Generated by envsgen
â”‚       â””â”€â”€ src/
â”‚           â””â”€â”€ index.php
â”œâ”€â”€ generate.sh           # Script to generate all configs
â””â”€â”€ README.md
```

---

## ðŸ“ Step 1: Create the Configuration Files

### `configs/shared.toml` - Shared Secrets & Variables

This file contains all shared secrets and variables that will be referenced across your entire stack.

```toml
# =============================================================================
# SHARED SECRETS & VARIABLES
# =============================================================================
# All sensitive data and shared configuration lives here.
# Reference these values using ${shared.KEY} syntax in other files.

[shared]
# Application Secrets
APP_KEY = "base64:xK9YhJdR3mN2pQ5vW8zB1cF4gH7jL0sT6uV9wX2yA1="
JWT_SECRET = "your-super-secret-jwt-key-change-in-production"

# Domain Configuration
DOMAIN = "myphpapp.com"
PROD_DOMAIN = "www.myphpapp.com"
LOCAL_DOMAIN = "localhost"

# API Configuration  
API_VERSION = "v1"
API_PREFIX = "/api/${shared.API_VERSION}"

# External Service Keys (can be loaded from environment)
STRIPE_PUBLIC_KEY = "${envs.STRIPE_PUBLIC_KEY}"
STRIPE_SECRET_KEY = "${envs.STRIPE_SECRET_KEY}"
SENDGRID_API_KEY = "${envs.SENDGRID_API_KEY}"

# Encryption key loaded from environment variable for security
ENCRYPTION_KEY = "${envs.APP_ENCRYPTION_KEY}"

# =============================================================================
# DATABASE CONFIGURATION
# =============================================================================

[shared.mysql.local]
MYSQL_HOST = "mysql"
MYSQL_PORT = 3306
MYSQL_ROOT_PASSWORD = "local_root_password_123"
MYSQL_USER = "phpapp_user"
MYSQL_PASSWORD = "local_user_password_456"
MYSQL_DATABASE = "myphpapp_db"

[shared.mysql.prod]
MYSQL_HOST = "mysql"
MYSQL_PORT = 3306
MYSQL_ROOT_PASSWORD = "${envs.MYSQL_ROOT_PASSWORD}"
MYSQL_USER = "phpapp_user"
MYSQL_PASSWORD = "${envs.MYSQL_PASSWORD}"
MYSQL_DATABASE = "myphpapp_db"

# =============================================================================
# REDIS CONFIGURATION
# =============================================================================

[shared.redis.local]
REDIS_HOST = "redis"
REDIS_PORT = 6379
REDIS_PASSWORD = ""

[shared.redis.prod]
REDIS_HOST = "redis"
REDIS_PORT = 6379
REDIS_PASSWORD = "${envs.REDIS_PASSWORD}"

# =============================================================================
# DOCKER NETWORKING
# =============================================================================

[shared.docker]
NETWORK_NAME = "phpapp_network"

[shared.docker.gateway]
hostname = "host.docker.internal"
ip = "172.17.0.1"
```

### `configs/apps.toml` - PHP Application Configuration

```toml
# =============================================================================
# PHP APPLICATION CONFIGURATION
# =============================================================================

[php]
# Base configuration inherited by all environments
APP_NAME = "MyPHPApp"
APP_KEY = "${shared.APP_KEY}"
JWT_SECRET = "${shared.JWT_SECRET}"
LOG_CHANNEL = "stack"
CACHE_DRIVER = "redis"
SESSION_DRIVER = "redis"
QUEUE_CONNECTION = "redis"

# =============================================================================
# LOCAL ENVIRONMENT
# =============================================================================

[php.local]
APP_ENV = "local"
APP_DEBUG = true
APP_URL = "http://${shared.LOCAL_DOMAIN}:8080"
API_URL = "http://${shared.LOCAL_DOMAIN}:8080${shared.API_PREFIX}"

# Database
DB_CONNECTION = "mysql"
DB_HOST = "${shared.mysql.local.MYSQL_HOST}"
DB_PORT = "${shared.mysql.local.MYSQL_PORT}"
DB_DATABASE = "${shared.mysql.local.MYSQL_DATABASE}"
DB_USERNAME = "${shared.mysql.local.MYSQL_USER}"
DB_PASSWORD = "${shared.mysql.local.MYSQL_PASSWORD}"

# Redis
REDIS_HOST = "${shared.redis.local.REDIS_HOST}"
REDIS_PORT = "${shared.redis.local.REDIS_PORT}"
REDIS_PASSWORD = "${shared.redis.local.REDIS_PASSWORD}"

# External Services (test keys)
STRIPE_KEY = "${shared.STRIPE_PUBLIC_KEY}"
STRIPE_SECRET = "${shared.STRIPE_SECRET_KEY}"
MAIL_MAILER = "log"

# Encryption
ENCRYPTION_KEY = "${shared.ENCRYPTION_KEY}"

# =============================================================================
# PRODUCTION ENVIRONMENT
# =============================================================================

[php.prod]
APP_ENV = "production"
APP_DEBUG = false
APP_URL = "https://${shared.PROD_DOMAIN}"
API_URL = "https://${shared.PROD_DOMAIN}${shared.API_PREFIX}"

# Database
DB_CONNECTION = "mysql"
DB_HOST = "${shared.mysql.prod.MYSQL_HOST}"
DB_PORT = "${shared.mysql.prod.MYSQL_PORT}"
DB_DATABASE = "${shared.mysql.prod.MYSQL_DATABASE}"
DB_USERNAME = "${shared.mysql.prod.MYSQL_USER}"
DB_PASSWORD = "${shared.mysql.prod.MYSQL_PASSWORD}"

# Redis
REDIS_HOST = "${shared.redis.prod.REDIS_HOST}"
REDIS_PORT = "${shared.redis.prod.REDIS_PORT}"
REDIS_PASSWORD = "${shared.redis.prod.REDIS_PASSWORD}"

# External Services (live keys)
STRIPE_KEY = "${shared.STRIPE_PUBLIC_KEY}"
STRIPE_SECRET = "${shared.STRIPE_SECRET_KEY}"
MAIL_MAILER = "smtp"
MAIL_HOST = "smtp.sendgrid.net"
MAIL_PORT = 587
MAIL_USERNAME = "apikey"
MAIL_PASSWORD = "${shared.SENDGRID_API_KEY}"

# Encryption
ENCRYPTION_KEY = "${shared.ENCRYPTION_KEY}"

# =============================================================================
# STAGING ENVIRONMENT
# =============================================================================

[php.staging]
APP_ENV = "staging"
APP_DEBUG = true
APP_URL = "https://staging.${shared.DOMAIN}"
API_URL = "https://staging.${shared.DOMAIN}${shared.API_PREFIX}"

# Database (uses prod database config but different db name)
DB_CONNECTION = "mysql"
DB_HOST = "${shared.mysql.prod.MYSQL_HOST}"
DB_PORT = "${shared.mysql.prod.MYSQL_PORT}"
DB_DATABASE = "myphpapp_staging"
DB_USERNAME = "${shared.mysql.prod.MYSQL_USER}"
DB_PASSWORD = "${shared.mysql.prod.MYSQL_PASSWORD}"

# Redis
REDIS_HOST = "${shared.redis.prod.REDIS_HOST}"
REDIS_PORT = "${shared.redis.prod.REDIS_PORT}"
REDIS_PASSWORD = "${shared.redis.prod.REDIS_PASSWORD}"

STRIPE_KEY = "${shared.STRIPE_PUBLIC_KEY}"
STRIPE_SECRET = "${shared.STRIPE_SECRET_KEY}"
MAIL_MAILER = "log"

ENCRYPTION_KEY = "${shared.ENCRYPTION_KEY}"
```

### `configs/docker.toml` - Docker Compose Configuration

```toml
# =============================================================================
# DOCKER COMPOSE CONFIGURATION
# =============================================================================

# =============================================================================
# LOCAL DEVELOPMENT STACK
# =============================================================================

[docker.local.services.caddy]
image = "caddy:2-alpine"
container_name = "phpapp_caddy"
restart = "unless-stopped"
cap_add = ["NET_ADMIN"]
ports = ["80:80", "443:443", "443:443/udp"]
volumes = [
    "../caddy/Caddyfile:/etc/caddy/Caddyfile:ro",
    "caddy_data:/data",
    "caddy_config:/config"
]
depends_on = ["php"]
networks = ["phpapp_network"]

[docker.local.services.php]
image = "php:8.2-fpm-alpine"
container_name = "phpapp_php"
restart = "unless-stopped"
working_dir = "/var/www/html"
volumes = [
    "../apps/myphpapp.com/src:/var/www/html:cached",
    "./php/php.ini:/usr/local/etc/php/php.ini:ro"
]
depends_on = ["mysql", "redis"]
networks = ["phpapp_network"]

[docker.local.services.php.environment]
APP_ENV = "local"
APP_DEBUG = "true"
DB_HOST = "${shared.mysql.local.MYSQL_HOST}"
DB_DATABASE = "${shared.mysql.local.MYSQL_DATABASE}"
DB_USERNAME = "${shared.mysql.local.MYSQL_USER}"
DB_PASSWORD = "${shared.mysql.local.MYSQL_PASSWORD}"
REDIS_HOST = "${shared.redis.local.REDIS_HOST}"

[docker.local.services.mysql]
image = "mysql:8.0"
container_name = "phpapp_mysql"
restart = "unless-stopped"
ports = ["3306:3306"]
volumes = ["mysql_data:/var/lib/mysql"]
networks = ["phpapp_network"]

[docker.local.services.mysql.environment]
MYSQL_ROOT_PASSWORD = "${shared.mysql.local.MYSQL_ROOT_PASSWORD}"
MYSQL_USER = "${shared.mysql.local.MYSQL_USER}"
MYSQL_PASSWORD = "${shared.mysql.local.MYSQL_PASSWORD}"
MYSQL_DATABASE = "${shared.mysql.local.MYSQL_DATABASE}"

[docker.local.services.redis]
image = "redis:7-alpine"
container_name = "phpapp_redis"
restart = "unless-stopped"
ports = ["6379:6379"]
volumes = ["redis_data:/data"]
networks = ["phpapp_network"]

[docker.local.services.phpmyadmin]
image = "phpmyadmin:latest"
container_name = "phpapp_phpmyadmin"
restart = "unless-stopped"
ports = ["8081:80"]
depends_on = ["mysql"]
networks = ["phpapp_network"]

[docker.local.services.phpmyadmin.environment]
PMA_HOST = "mysql"
PMA_USER = "root"
PMA_PASSWORD = "${shared.mysql.local.MYSQL_ROOT_PASSWORD}"

# Volumes
[docker.local.volumes]
caddy_data = {}
caddy_config = {}
mysql_data = {}
redis_data = {}

# Networks
[docker.local.networks.phpapp_network]
driver = "bridge"

# =============================================================================
# PRODUCTION STACK
# =============================================================================

[docker.prod.services.caddy]
image = "caddy:2-alpine"
container_name = "phpapp_caddy"
restart = "always"
cap_add = ["NET_ADMIN"]
ports = ["80:80", "443:443", "443:443/udp"]
volumes = [
    "../caddy/Caddyfile:/etc/caddy/Caddyfile:ro",
    "caddy_data:/data",
    "caddy_config:/config"
]
extra_hosts = ["${shared.docker.gateway.hostname}:${shared.docker.gateway.ip}"]
depends_on = ["php"]
networks = ["phpapp_network"]

[docker.prod.services.php]
build = "../apps/myphpapp.com"
container_name = "phpapp_php"
restart = "always"
working_dir = "/var/www/html"
depends_on = ["mysql", "redis"]
networks = ["phpapp_network"]

[docker.prod.services.php.environment]
APP_ENV = "production"
APP_DEBUG = "false"
DB_HOST = "${shared.mysql.prod.MYSQL_HOST}"
DB_DATABASE = "${shared.mysql.prod.MYSQL_DATABASE}"
DB_USERNAME = "${shared.mysql.prod.MYSQL_USER}"
DB_PASSWORD = "${shared.mysql.prod.MYSQL_PASSWORD}"
REDIS_HOST = "${shared.redis.prod.REDIS_HOST}"
REDIS_PASSWORD = "${shared.redis.prod.REDIS_PASSWORD}"

[docker.prod.services.mysql]
image = "mysql:8.0"
container_name = "phpapp_mysql"
restart = "always"
volumes = [
    "mysql_data:/var/lib/mysql",
    "./mysql/my.cnf:/etc/mysql/conf.d/my.cnf:ro"
]
networks = ["phpapp_network"]

[docker.prod.services.mysql.environment]
MYSQL_ROOT_PASSWORD = "${shared.mysql.prod.MYSQL_ROOT_PASSWORD}"
MYSQL_USER = "${shared.mysql.prod.MYSQL_USER}"
MYSQL_PASSWORD = "${shared.mysql.prod.MYSQL_PASSWORD}"
MYSQL_DATABASE = "${shared.mysql.prod.MYSQL_DATABASE}"

[docker.prod.services.redis]
image = "redis:7-alpine"
container_name = "phpapp_redis"
restart = "always"
command = "redis-server --requirepass ${shared.redis.prod.REDIS_PASSWORD}"
volumes = ["redis_data:/data"]
networks = ["phpapp_network"]

# Volumes
[docker.prod.volumes]
caddy_data = {}
caddy_config = {}
mysql_data = {}
redis_data = {}

# Networks
[docker.prod.networks.phpapp_network]
driver = "bridge"
```

### `configs/caddy.toml` - Caddyfile Configuration

This is where we demonstrate the special `_` (underscore) syntax for handling multiple values with the same key in Caddyfiles.

```toml
# =============================================================================
# CADDYFILE CONFIGURATION
# =============================================================================
# 
# IMPORTANT: The "_" (underscore) syntax explained:
# 
# Caddy configuration often requires multiple directives with the same key name.
# For example, load balancing requires multiple "to" directives:
#
#   reverse_proxy /api/* {
#       to http://backend1:8080
#       to http://backend2:8080
#       to http://backend3:8080
#   }
#
# Since TOML only allows unique keys, envsgen uses a special "_" key with an
# array to generate multiple lines with the same directive:
#
#   [caddy.caddyfile."example.com"."reverse_proxy /api/*".to]
#   _ = [
#       "http://backend1:8080",
#       "http://backend2:8080", 
#       "http://backend3:8080",
#   ]
#
# This outputs:
#   to http://backend1:8080
#   to http://backend2:8080
#   to http://backend3:8080
# =============================================================================

# =============================================================================
# LOCAL DEVELOPMENT
# =============================================================================

[caddy.local."localhost:8080"]
# Reverse proxy to PHP-FPM
reverse_proxy = "php:9000"

[caddy.local."localhost:8080".php_fastcgi]
root = "* /var/www/html"
split_path = '".php"'

# =============================================================================
# PRODUCTION - Main Site (Redirect non-www to www)
# =============================================================================

[caddy.prod."myphpapp.com"]
# Redirect to www version
redir = "https://www.myphpapp.com{uri}"

# =============================================================================
# PRODUCTION - WWW Site (Main Application)
# =============================================================================

[caddy.prod."www.myphpapp.com"]
# Enable compression
encode = "gzip zstd"

# Security headers block
[caddy.prod."www.myphpapp.com".header]
"Strict-Transport-Security" = '"max-age=31536000; includeSubDomains; preload"'
"X-Frame-Options" = '"DENY"'
"X-Content-Type-Options" = '"nosniff"'
"X-XSS-Protection" = '"1; mode=block"'
"Referrer-Policy" = '"strict-origin-when-cross-origin"'
"Content-Security-Policy" = '"default-src '\''self'\''"'

# Static file matcher
[caddy.prod."www.myphpapp.com"."@static"]
path = ["*.css", "*.js", "*.png", "*.jpg", "*.jpeg", "*.gif", "*.svg", "*.webp", "*.ico", "*.woff2"]

# Handle static files
[caddy.prod."www.myphpapp.com"."handle @static"]
root = "* /var/www/html/public"
file_server = ""

[caddy.prod."www.myphpapp.com"."handle @static".header]
"Cache-Control" = '"public, max-age=31536000, immutable"'

# PHP FastCGI for main application
[caddy.prod."www.myphpapp.com"."php_fastcgi php:9000"]
root = "* /var/www/html/public"
index = "index.php"

# =============================================================================
# PRODUCTION - API with Load Balancing
# =============================================================================
# This demonstrates the "_" underscore syntax for multiple backend servers

[caddy.prod."api.myphpapp.com"]
encode = "gzip"

# API reverse proxy with load balancing
[caddy.prod."api.myphpapp.com"."reverse_proxy /v1/*"]
lb_policy = "round_robin"
health_uri = '"/health"'
health_interval = "10s"
health_timeout = "5s"
fail_duration = "30s"

# The "_" syntax creates multiple "to" directives for load balancing
# This will output:
#   to http://php-api-1:9000
#   to http://php-api-2:9000
#   to http://php-api-3:9000
[caddy.prod."api.myphpapp.com"."reverse_proxy /v1/*".to]
_ = [
    "http://php-api-1:9000",
    "http://php-api-2:9000",
    "http://php-api-3:9000",
]

# Transport configuration
[caddy.prod."api.myphpapp.com"."reverse_proxy /v1/*"."transport http"]
read_timeout = "30s"
write_timeout = "30s"
dial_timeout = "5s"

# Rate limiting
[caddy.prod."api.myphpapp.com".rate_limit]
zone = "api_zone"
rate = "100r/m"

# =============================================================================
# PRODUCTION - WebSocket Server
# =============================================================================

[caddy.prod."ws.myphpapp.com"]
# WebSocket matcher
"@websocket" = { header = ["Connection *Upgrade*", "Upgrade websocket"] }

# Handle WebSocket connections
[caddy.prod."ws.myphpapp.com"."reverse_proxy @websocket ws://websocket:6001"]
header_up = ["Host {host}", "X-Real-IP {remote_ip}", "X-Forwarded-For {remote_ip}"]

# CORS headers
[caddy.prod."ws.myphpapp.com".header]
"Access-Control-Allow-Origin" = '"*"'
"Access-Control-Allow-Methods" = '"GET, POST, OPTIONS"'
"Access-Control-Allow-Headers" = '"*"'

# =============================================================================
# PRODUCTION - Admin Panel (Basic Auth Protected)
# =============================================================================

[caddy.prod."admin.myphpapp.com"]
# Basic authentication - password should be hashed with: caddy hash-password
[caddy.prod."admin.myphpapp.com"."basicauth /"]
admin = "$2a$14$YourHashedPasswordHere..."

[caddy.prod."admin.myphpapp.com"."reverse_proxy php:9000"]
root = "* /var/www/html/admin"

# =============================================================================
# STAGING ENVIRONMENT
# =============================================================================

[caddy.staging."staging.myphpapp.com"]
encode = "gzip"

[caddy.staging."staging.myphpapp.com"."php_fastcgi php:9000"]
root = "* /var/www/html/public"
index = "index.php"

# Basic auth to protect staging
[caddy.staging."staging.myphpapp.com"."basicauth /"]
staging = "$2a$14$StagingHashedPasswordHere..."
```

### `configs/master.toml` - Main Entry Point

```toml
# =============================================================================
# MASTER CONFIGURATION FILE
# =============================================================================
# This file imports all other configuration files in the correct order.
# Always import shared.toml first as other files depend on it.

#!import shared
#!import apps
#!import docker
#!import caddy
```

---

## ðŸ”§ Step 2: Create the Generation Script

### `generate.sh` - Generate All Configurations

```bash
#!/bin/bash

# =============================================================================
# ENVSGEN CONFIGURATION GENERATOR
# =============================================================================
# This script generates all configuration files from the master TOML config.
# 
# Usage:
#   ./generate.sh              # Generate all configs
#   ./generate.sh --local      # Generate local configs only
#   ./generate.sh --prod       # Generate production configs only
#   ./generate.sh --clean      # Remove all generated files
# =============================================================================

set -e  # Exit on error

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Project root directory (where this script lives)
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
cd "$SCRIPT_DIR"

# Configuration
CONFIG_FILE="configs/master.toml"
ENVSGEN="envsgen"

# =============================================================================
# HELPER FUNCTIONS
# =============================================================================

log_info() {
    echo -e "${BLUE}[INFO]${NC} $1"
}

log_success() {
    echo -e "${GREEN}[SUCCESS]${NC} $1"
}

log_warn() {
    echo -e "${YELLOW}[WARN]${NC} $1"
}

log_error() {
    echo -e "${RED}[ERROR]${NC} $1"
    exit 1
}

check_envsgen() {
    if ! command -v "$ENVSGEN" &> /dev/null; then
        log_error "envsgen not found. Please install it first:\n  make install\n  # or\n  go install ./\n"
    fi
}

ensure_dirs() {
    mkdir -p apps/myphpapp.com
    mkdir -p caddy
    mkdir -p docker
}

# =============================================================================
# ENVIRONMENT VARIABLE VALIDATION
# =============================================================================
# These environment variables should be set for production builds.
# For local development, you can use placeholder values or set them to empty.

validate_env_vars() {
    local missing=()
    
    # Required for production
    if [ "$1" = "prod" ] || [ "$1" = "all" ]; then
        [ -z "$MYSQL_ROOT_PASSWORD" ] && missing+=("MYSQL_ROOT_PASSWORD")
        [ -z "$MYSQL_PASSWORD" ] && missing+=("MYSQL_PASSWORD")
        [ -z "$REDIS_PASSWORD" ] && missing+=("REDIS_PASSWORD")
    fi
    
    # Optional but recommended
    [ -z "$APP_ENCRYPTION_KEY" ] && log_warn "APP_ENCRYPTION_KEY not set, using default"
    [ -z "$STRIPE_PUBLIC_KEY" ] && log_warn "STRIPE_PUBLIC_KEY not set"
    [ -z "$STRIPE_SECRET_KEY" ] && log_warn "STRIPE_SECRET_KEY not set"
    [ -z "$SENDGRID_API_KEY" ] && log_warn "SENDGRID_API_KEY not set"
    
    if [ ${#missing[@]} -gt 0 ]; then
        log_error "Missing required environment variables for production:\n  ${missing[*]}\n\nSet them or use --local flag for development."
    fi
}

# =============================================================================
# GENERATION FUNCTIONS
# =============================================================================

generate_local_envs() {
    log_info "Generating local .env files..."
    
    "$ENVSGEN" "$CONFIG_FILE" php.local \
        -o apps/myphpapp.com/.env.local
    log_success "Generated apps/myphpapp.com/.env.local"
}

generate_prod_envs() {
    log_info "Generating production .env files..."
    
    "$ENVSGEN" "$CONFIG_FILE" php.prod \
        -o apps/myphpapp.com/.env.prod
    log_success "Generated apps/myphpapp.com/.env.prod"
    
    "$ENVSGEN" "$CONFIG_FILE" php.staging \
        -o apps/myphpapp.com/.env.staging
    log_success "Generated apps/myphpapp.com/.env.staging"
}

generate_docker_local() {
    log_info "Generating local Docker Compose..."
    
    "$ENVSGEN" "$CONFIG_FILE" docker.local \
        --docker \
        -o docker/docker-compose.local.yml
    log_success "Generated docker/docker-compose.local.yml"
}

generate_docker_prod() {
    log_info "Generating production Docker Compose..."
    
    "$ENVSGEN" "$CONFIG_FILE" docker.prod \
        --docker \
        -o docker/docker-compose.prod.yml
    log_success "Generated docker/docker-compose.prod.yml"
}

generate_caddy_local() {
    log_info "Generating local Caddyfile..."
    
    "$ENVSGEN" "$CONFIG_FILE" caddy.local \
        --caddy \
        -o caddy/Caddyfile.local
    log_success "Generated caddy/Caddyfile.local"
}

generate_caddy_prod() {
    log_info "Generating production Caddyfile..."
    
    "$ENVSGEN" "$CONFIG_FILE" caddy.prod \
        --caddy \
        -o caddy/Caddyfile.prod
    log_success "Generated caddy/Caddyfile.prod"
    
    "$ENVSGEN" "$CONFIG_FILE" caddy.staging \
        --caddy \
        -o caddy/Caddyfile.staging
    log_success "Generated caddy/Caddyfile.staging"
}

generate_bash_exports() {
    log_info "Generating Bash export scripts..."
    
    "$ENVSGEN" "$CONFIG_FILE" php.local \
        --bash \
        -o scripts/set-env-local.sh
    chmod +x scripts/set-env-local.sh 2>/dev/null || true
    log_success "Generated scripts/set-env-local.sh"
    
    "$ENVSGEN" "$CONFIG_FILE" php.prod \
        --bash \
        -o scripts/set-env-prod.sh
    chmod +x scripts/set-env-prod.sh 2>/dev/null || true
    log_success "Generated scripts/set-env-prod.sh"
}

generate_json_config() {
    log_info "Generating JSON configuration (for debugging)..."
    
    mkdir -p debug
    "$ENVSGEN" "$CONFIG_FILE" php.local \
        --json \
        -o debug/config-local.json
    log_success "Generated debug/config-local.json"
}

clean_generated() {
    log_info "Cleaning generated files..."
    
    rm -f apps/myphpapp.com/.env.local
    rm -f apps/myphpapp.com/.env.prod
    rm -f apps/myphpapp.com/.env.staging
    rm -f docker/docker-compose.local.yml
    rm -f docker/docker-compose.prod.yml
    rm -f caddy/Caddyfile.local
    rm -f caddy/Caddyfile.prod
    rm -f caddy/Caddyfile.staging
    rm -f scripts/set-env-local.sh
    rm -f scripts/set-env-prod.sh
    rm -rf debug/
    
    log_success "All generated files removed"
}

# =============================================================================
# MAIN
# =============================================================================

main() {
    echo ""
    echo "=================================================="
    echo "  ENVSGEN Configuration Generator"
    echo "=================================================="
    echo ""
    
    check_envsgen
    ensure_dirs
    mkdir -p scripts
    
    case "${1:-all}" in
        --local|-l)
            log_info "Generating LOCAL configurations only..."
            generate_local_envs
            generate_docker_local
            generate_caddy_local
            ;;
        --prod|-p)
            log_info "Generating PRODUCTION configurations only..."
            validate_env_vars "prod"
            generate_prod_envs
            generate_docker_prod
            generate_caddy_prod
            ;;
        --clean|-c)
            clean_generated
            exit 0
            ;;
        --help|-h)
            echo "Usage: $0 [option]"
            echo ""
            echo "Options:"
            echo "  --local, -l    Generate local development configs only"
            echo "  --prod, -p     Generate production configs only"
            echo "  --clean, -c    Remove all generated files"
            echo "  --help, -h     Show this help message"
            echo ""
            echo "With no options, generates all configurations."
            exit 0
            ;;
        all|*)
            log_info "Generating ALL configurations..."
            
            # Local
            generate_local_envs
            generate_docker_local
            generate_caddy_local
            
            # Production (if env vars are set)
            if [ -n "$MYSQL_ROOT_PASSWORD" ]; then
                generate_prod_envs
                generate_docker_prod
                generate_caddy_prod
            else
                log_warn "Skipping production configs (env vars not set)"
            fi
            
            # Extra outputs
            generate_bash_exports
            generate_json_config
            ;;
    esac
    
    echo ""
    log_success "Configuration generation complete!"
    echo ""
}

main "$@"
```

Make the script executable:

```bash
chmod +x generate.sh
```

---

## ðŸš€ Step 3: Generate Your Configurations

### Set Required Environment Variables

For local development:

```bash
# Optional for local development
export APP_ENCRYPTION_KEY="your-32-character-encryption-key"
export STRIPE_PUBLIC_KEY="pk_test_xxx"
export STRIPE_SECRET_KEY="sk_test_xxx"
export SENDGRID_API_KEY="SG.xxx"
```

For production:

```bash
# Required for production
export MYSQL_ROOT_PASSWORD="secure-root-password"
export MYSQL_PASSWORD="secure-user-password"
export REDIS_PASSWORD="secure-redis-password"
export APP_ENCRYPTION_KEY="your-production-encryption-key"
export STRIPE_PUBLIC_KEY="pk_live_xxx"
export STRIPE_SECRET_KEY="sk_live_xxx"
export SENDGRID_API_KEY="SG.xxx"
```

### Run the Generator

```bash
# Generate all configurations
./generate.sh

# Generate only local configs
./generate.sh --local

# Generate only production configs (requires env vars)
./generate.sh --prod

# Clean all generated files
./generate.sh --clean
```

---

## ðŸ“¤ Generated Output Examples

### Generated `.env.local` (PHP Application)

```dotenv
APP_NAME=MyPHPApp
APP_KEY=base64:xK9YhJdR3mN2pQ5vW8zB1cF4gH7jL0sT6uV9wX2yA1=
APP_ENV=local
APP_DEBUG=true
APP_URL=http://localhost:8080
API_URL=http://localhost:8080/api/v1
JWT_SECRET=your-super-secret-jwt-key-change-in-production
LOG_CHANNEL=stack
CACHE_DRIVER=redis
SESSION_DRIVER=redis
QUEUE_CONNECTION=redis
DB_CONNECTION=mysql
DB_HOST=mysql
DB_PORT=3306
DB_DATABASE=myphpapp_db
DB_USERNAME=phpapp_user
DB_PASSWORD=local_user_password_456
REDIS_HOST=redis
REDIS_PORT=6379
REDIS_PASSWORD=
STRIPE_KEY=pk_test_xxx
STRIPE_SECRET=sk_test_xxx
MAIL_MAILER=log
ENCRYPTION_KEY=your-32-character-encryption-key
```

### Generated `docker-compose.local.yml`

```yaml
networks:
  phpapp_network:
    driver: bridge
services:
  caddy:
    cap_add:
      - NET_ADMIN
    container_name: phpapp_caddy
    depends_on:
      - php
    image: caddy:2-alpine
    networks:
      - phpapp_network
    ports:
      - 80:80
      - 443:443
      - 443:443/udp
    restart: unless-stopped
    volumes:
      - ../caddy/Caddyfile:/etc/caddy/Caddyfile:ro
      - caddy_data:/data
      - caddy_config:/config
  mysql:
    container_name: phpapp_mysql
    environment:
      MYSQL_DATABASE: myphpapp_db
      MYSQL_PASSWORD: local_user_password_456
      MYSQL_ROOT_PASSWORD: local_root_password_123
      MYSQL_USER: phpapp_user
    image: mysql:8.0
    networks:
      - phpapp_network
    ports:
      - 3306:3306
    restart: unless-stopped
    volumes:
      - mysql_data:/var/lib/mysql
  php:
    container_name: phpapp_php
    depends_on:
      - mysql
      - redis
    environment:
      APP_DEBUG: "true"
      APP_ENV: local
      DB_DATABASE: myphpapp_db
      DB_HOST: mysql
      DB_PASSWORD: local_user_password_456
      DB_USERNAME: phpapp_user
      REDIS_HOST: redis
    image: php:8.2-fpm-alpine
    networks:
      - phpapp_network
    restart: unless-stopped
    volumes:
      - ../apps/myphpapp.com/src:/var/www/html:cached
      - ./php/php.ini:/usr/local/etc/php/php.ini:ro
    working_dir: /var/www/html
  phpmyadmin:
    container_name: phpapp_phpmyadmin
    depends_on:
      - mysql
    environment:
      PMA_HOST: mysql
      PMA_PASSWORD: local_root_password_123
      PMA_USER: root
    image: phpmyadmin:latest
    networks:
      - phpapp_network
    ports:
      - 8081:80
    restart: unless-stopped
  redis:
    container_name: phpapp_redis
    image: redis:7-alpine
    networks:
      - phpapp_network
    ports:
      - 6379:6379
    restart: unless-stopped
    volumes:
      - redis_data:/data
volumes:
  caddy_config: {}
  caddy_data: {}
  mysql_data: {}
  redis_data: {}
```

### Generated `Caddyfile.prod` (with `_` underscore syntax)

```caddyfile
myphpapp.com {
	redir https://www.myphpapp.com{uri}
}

www.myphpapp.com {
	encode gzip zstd
	header {
		Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
		X-Frame-Options "DENY"
		X-Content-Type-Options "nosniff"
		X-XSS-Protection "1; mode=block"
		Referrer-Policy "strict-origin-when-cross-origin"
		Content-Security-Policy "default-src 'self'"
	}
	@static {
		path *.css *.js *.png *.jpg *.jpeg *.gif *.svg *.webp *.ico *.woff2
	}
	handle @static {
		root * /var/www/html/public
		file_server
		header {
			Cache-Control "public, max-age=31536000, immutable"
		}
	}
	php_fastcgi php:9000 {
		root * /var/www/html/public
		index index.php
	}
}

api.myphpapp.com {
	encode gzip
	reverse_proxy /v1/* {
		lb_policy round_robin
		health_uri "/health"
		health_interval 10s
		health_timeout 5s
		fail_duration 30s

		to http://php-api-1:9000
		to http://php-api-2:9000
		to http://php-api-3:9000

		transport http {
			read_timeout 30s
			write_timeout 30s
			dial_timeout 5s
		}
	}
	rate_limit {
		zone api_zone
		rate 100r/m
	}
}

ws.myphpapp.com {
	@websocket header Connection *Upgrade* header Upgrade websocket
	reverse_proxy @websocket ws://websocket:6001 {
		header_up Host {host} X-Real-IP {remote_ip} X-Forwarded-For {remote_ip}
	}
	header {
		Access-Control-Allow-Origin "*"
		Access-Control-Allow-Methods "GET, POST, OPTIONS"
		Access-Control-Allow-Headers "*"
	}
}

admin.myphpapp.com {
	basicauth / {
		admin $2a$14$YourHashedPasswordHere...
	}
	reverse_proxy php:9000 {
		root * /var/www/html/admin
	}
}
```

---


### Variable Interpolation Types

1. **TOML References**: `${shared.JWT_SECRET}` - Reference other keys in the config
2. **Environment Variables**: `${envs.MY_SECRET}` - Reference OS environment variables
3. **Shell Commands**: `${`git rev-parse --short HEAD`}` - Execute shell commands (requires `--allow-shell`)

### Import System

Use `#!import` to split configs into multiple files:

```toml
#!import shared           # imports shared.toml
#!import ./configs/apps   # .toml extension added automatically
#!import /abs/path/file   # absolute paths supported
```

---

## ðŸŽ‰ Quick Start Commands

```bash
# 1. Create project structure
mkdir -p myproject/{configs,apps/myphpapp.com/src,caddy,docker,scripts}
cd myproject

# 2. Copy the configuration files from this tutorial

# 3. Set environment variables
export APP_ENCRYPTION_KEY="your-32-character-encryption-key"

# 4. Generate all configs
./generate.sh --local

# 5. Start the stack
cd docker && docker-compose -f docker-compose.local.yml up -d

# 6. Visit http://localhost:8080
```

---

## ðŸ“– Additional Resources

- [Envsgen README](./README.md)
- [Caddy Documentation](https://caddyserver.com/docs/) - Caddyfile reference
- [Docker Compose Docs](https://docs.docker.com/compose/) - Docker Compose reference
- [TOML Specification](https://toml.io/) - TOML format reference

---

**Happy configuring! ðŸš€**

